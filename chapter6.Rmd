# Chapter 6: Analysis of longitudinal data

- It would have been nice to be able to get more out of this weeks exercises and materials; it is easy to simply copy and modify the code, but I would like to learn much more

```{r message=FALSE, warning=FALSE}
date()

# packages in use
library(dplyr)
library(ggplot2)
library(tidyr)

```

## 6.1 RATS

In this subchapter I will implement the analyses of Chapter 8 of MABS using the RATS data.

### 6.1.1 Data

The RATS data utilized here is drawn from a nutrition study conducted with rats ([see Crowder & Hand 1990](https://www.routledge.com/Analysis-of-Repeated-Measures/Crowder-Hand/p/book/9780367450847)). In the experiment the rats were grouped into three groups which had different diets, and each rats’s weight (grams) was recorded repeatedly over a 9-week
period (about weekly, with an exception of week seven when two measurement were taken). 

The original RATS data included 16 observations of 13 variables, that is 16 rats with multiple measurements over time (and a few other variables). Here, the data is transformed from wide to long format by time (measurements), meaning that each time point (i.e. measurement) is forms an observation and, thus, every individual rat has as many observations as there are measurements. Thererore, in the long format there are 176 observations of 4 variables, which are:

- ID: unique id of participants (rats)
- Group: the treatment groups 1,2 and 3
- Weight: rats' weight in grams
- Time: time point (days) of the weight measurement

NB: The variable 'WD' is removed from the data set as its information is already included in the 'Time' variable and thus there is no use for it. In addition, ID and Group variables are transformed to factors.

```{r message=FALSE, warning=FALSE}
# load the data in long format
rats_long <- read.table("data/rats_long.csv", sep = ";")

# prepare data for the analysis
## remove WD variable 
## Group and ID -> factors
rats_long <- rats_long %>%
  select(-WD) %>%
  mutate(Group = as.factor(Group),
         ID = as.factor(ID))

str(rats_long)
head(rats_long)
glimpse(rats_long)
```

### 6.1.2 Graphical examination of the data

First, I draw a plot for every observed rat; the plot shows measured weight (y-axis) over time (x-axis) for every rat (lines). Rats in every group have gained weight during the experiment, although the growth seems to be bigger in groups 2 and 3 compared to group 1. However, the plot also illustrates that in the beginning of the experiment (time 0) the rats differ from each other in terms of the weight and bigger rats are bigger throughout the experiment. Rats in group 1 are much smaller than those in the groups 2 and 3. Also there is one much bigger individual in the group 2. 

```{r message=FALSE, warning=FALSE}

# Draw a plot for rats in each group over time
ggplot(rats_long, aes(x = Time, y = Weight, linetype = ID, col = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, times=4)) + #what this does?
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(rats_long$Weight), max(rats_long$Weight)))

```
Next, I will standardize/center the weight variable and repeat the above-presented graphical examination. The graphical results are similar, although the trend in weight gain does not seem to be as straightforward as in the previous plot, especially regarding group 3.

```{r message=FALSE, warning=FALSE}

# Standardize the variable weight
rats_long<- rats_long %>%
  group_by(Time) %>%
  mutate(Weight_std = (Weight - mean(Weight)) / sd(Weight)) %>%
  ungroup()

# Draw the plot using the stardardixed weight variable
ggplot(rats_long, aes(x = Time, y = Weight_std, linetype = ID, col = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, times=4)) + #what this does?
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(name = "Standardized weight")

```

Following the instructions of this exercise I will next produce a graph showing average profiles for each group to get a better picture of the differences between the treatment groups. Although I have to say, that with this data, it would be more interesting to examine whether the change in gaining weights differs between the groups as the groups differ by the design of the study.

Anyways, the graph shows that means of weights of groups 2 and 3 clearly differs from the group 1. In addition, although there is some overlap between the groups 2 and 3 it seems that they do differ from each other as the standard errors do not overlap with the other group's means. 


```{r message=FALSE, warning=FALSE}

# Summary data with mean and standard error of weight by treatment group and time

# PROBLEM: DIFFRENT NUMBER OF RATS IN DIFFERENT GROUPS!
## how to take sqrt(n), where n = number of rats in group -> 
### n() which gives the current group size ??
rats_long_s <- rats_long %>%
  group_by(Group, Time) %>%
  summarise(mean = mean(Weight), se = sd(Weight) /  sqrt(n())) %>%
  ungroup()

# Plot the mean profiles
ggplot(rats_long_s , aes(x = Time, y = mean, linetype = Group, shape = Group, col = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.9,0.45)) +
  scale_y_continuous(name = "mean(weight) +/- se(weight)")

```

I will continue the summary approach and look into the post treatment values of the weight. The mean of the all weeks' weight will be our summary measure. Day 1 will be considered here as the baseline and it is excluded from the examination asI guess we are supposed to do. 

```{r}
# Create a summary data by group and subject with mean as the summary variable (ignoring baseline day 1).
rats_summary <- rats_long %>%
  filter(Time > 0) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()

# Draw a boxplot of the mean versus group
ggplot(rats_summary, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), days 8-64")

```

The box plots presented above shows again that the groups differ from each other and also that every group has an outlier, although only in the case of group two the outlier is quite far from the other means. Thus, I will remove the outlier of group 2 and draw the box plots again. 

```{r message=FALSE, warning=FALSE}
rats_summary_filt <- rats_summary %>%
  filter(mean < 550)

# Draw a boxplot of the mean versus group
ggplot(rats_summary_filt, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), days 8-64")
```

### 6.1.3 Statistical tests for differences

After removing the outlier, the differences between groups are even clearer as can be seen in the picture above. Here, I have to improvise as it is impossible to conduct same analyses that were implemented in the Datacamp exercise (Student's t-test). Hotelling's t-test can be used when there are more than two groups([see chapter 18 of MABS](https://mooc.helsinki.fi/pluginfile.php/192850/course/section/7333/MABS4IODS-Part4.pdf), which is the case here and, thus, I apply Hotelling’s test to investigate whether the differences between groups are statistically significant. I found Hotelling package which includes the test as well (see documentation on [Hotelling's package](https://cran.r-project.org/web/packages/Hotelling/Hotelling.pdf)). I admit, that I'm not not sure if that is the right one to use here, but it is my best guess. The results presented below show that not surprisingly all the groups' means are statistically significantly different from each other.

```{r message=FALSE, warning=FALSE}
# Access to Hotelling package
library(Hotelling)

# Hotelling's t-test
htest <- hotelling.test(mean ~ Group, data = rats_summary_filt, var.equal = TRUE)
htest 

# test between groups 1 and 2
htest2 <- hotelling.test(mean ~ Group, data = rats_summary_filt, pair = c(1,2), var.equal = TRUE)
htest2

# test between groups 1 and 3
htest3 <- hotelling.test(mean ~ Group, data = rats_summary_filt, pair = c(1,3), var.equal = TRUE)
htest3

# test between groups 2 and 3
htest4 <- hotelling.test(mean ~ Group, data = rats_summary_filt, pair = c(2,3), var.equal = TRUE)
htest4


```

Next, I will firs add the baseline measurement (day 1) from original data to the summary data and then utilize it in fitting a linear model in which the mean is the response variable. When taking the baseline into account results are quite different! According to the results from the linear regression model the coefficient of group 2 or 3 are not statistically significant. Analysis of variance provides similar results.

TSEKKAA KIRJAN JA DATACAMPIN SEPUSTUKSIA... MENEEKÖ NÄMÄ VITUIKS?

```{r message=FALSE, warning=FALSE}

## load the data in wide form
rats_wide <- read.table("data/rats_wide.csv", sep = ";")

# Add the baseline (Day 1) from the original data as a new variable to the summary data
rats_summary2 <- rats_summary %>%
  mutate(baseline = rats_wide$WD1)

# Fit the linear model with the mean as the response 
fit <- lm(mean ~ baseline + Group, data = rats_summary2)

# summary of the fitted model
summary(fit)
# analysis of variance table for the fitted model 
anova(fit)

```



## 6.2 BPRS

*_Implement the analyses of Chapter 9 of MABS using the BPRS data. (0-8 points: 0-4 points for graphs or analysis results + 0-4 points for their interpretations)_*

In this subchapter I will implement the analyses of Chapter 9 of MABS using the BPRS data.

### 6.2.1 Data

```{r message=FALSE, warning=FALSE}
# load the data in long format
bprs_long <- read.table("data/bprs_long.csv", sep = ";")

```

### 6.2.2 Something