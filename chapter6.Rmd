# Chapter 6: Analysis of longitudinal data

- It would have been nice to be able to get more out of this weeks exercises and materials; it is easy to simply copy and modify the code, but I would like to learn much more

```{r message=FALSE, warning=FALSE}
date()

# packages in use
library(dplyr)
library(ggplot2)
library(tidyr)

```

## 6.1 RATS

In this subchapter I will implement the analyses of Chapter 8 of MABS using the RATS data.

### 6.1.1 Data

The RATS data utilized here is drawn from a nutrition study conducted with rats ([see Crowder & Hand 1990](https://www.routledge.com/Analysis-of-Repeated-Measures/Crowder-Hand/p/book/9780367450847)). In the experiment the rats were grouped into three groups which had different diets, and each ratsâ€™s weight (grams) was recorded repeatedly over a 9-week
period (about weekly, with an exception of week seven when two measurement were taken). 

The original RATS data included 16 observations of 13 variables, that is 16 rats with multiple measurements over time (and a few other variables). Here, the data is transformed from wide to long format by time (measurements), meaning that each time point (i.e. measurement) is forms an observation and, thus, every individual rat has as many observations as there are measurements. Thererore, in the long format there are 176 observations of 4 variables, which are:

- ID: unique id of participants (rats)
- Group: the treatment groups 1,2 and 3
- Weight: rats' weight in grams
- Time: time point (days) of the weight measurement

NB: The variable 'WD' is removed from the data set as its information is already included in the 'Time' variable and thus there is no use for it. In addition, ID and Group variables are transformed to factors.

```{r message=FALSE, warning=FALSE}
# load the data in long format
rats_long <- read.table("data/rats_long.csv", sep = ";")

# prepare data for the analysis
## remove WD variable 
## Group and ID -> factors
rats_long <- rats_long %>%
  select(-WD) %>%
  mutate(Group = as.factor(Group),
         ID = as.factor(ID))

str(rats_long)
head(rats_long)
glimpse(rats_long)
```

### 6.1.2 Graphical examination of the data

First, I draw a plot for every observed rat; the plot shows measured weight (y-axis) over time (x-axis) for every rat (lines). Rats in every group have gained weight during the experiment, although the growth seems to be bigger in groups 2 and 3 compared to group 1. The plot also illustrates that in the beginning of the experiment (time 0) the rats differ from each other in terms of the weight and bigger rats are bigger throughout the experiment.. Rats in group one are much smaller than those in groups 2 and 3. Also there is one much bigger individual in the group 2. 

```{r message=FALSE, warning=FALSE}

# Draw a plot for rats in each group over time
ggplot(rats_long, aes(x = Time, y = Weight, linetype = ID, col = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, times=4)) + #what this does?
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(rats_long$Weight), max(rats_long$Weight)))

```
Next, I will standardize/center the weight variable and repeat the above-presented graphical examination. As the graph below shows the after standardizing the groups seem to differ from each other and the second group include an outlier. Interestingly the trend in weight gain does not seem to be as straightforward as in the previous plot, expecially regarding group 3.

```{r message=FALSE, warning=FALSE}

# Standardize the variable weight
rats_long<- rats_long %>%
  group_by(Time) %>%
  mutate(Weight_std = (Weight - mean(Weight)) / sd(Weight)) %>%
  ungroup()

# Draw the plot using the stardardixed weight variable
ggplot(rats_long, aes(x = Time, y = Weight_std, linetype = ID, col = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, times=4)) + #what this does?
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(name = "Standardized weight")

```

To get a better picture of the differences between the treatment groups I will next produce a graph showing average profiles for each group. The graph shows that means of wights of groups 2 and 3 clearly differs from the group 1. In addition, although there is some overlap between the groups 2 and 3 it seems that they do differ from each other as the standard errors do not overlap with the other group's means. This will be examined more together with removing the outlier.... 

Although it would be more interesting to examine whether the change in weights differs between the groups... I do not see why to examine whether the groups differ because they differ by the design of the study!

```{r message=FALSE, warning=FALSE}

# Summary data with mean and standard error of weight by treatment group and time

# PROBLEM: DIFFRENT NUMBER OF RATS IN DIFFERENT GROUPS!
## how to take sqrt(n), where n = number of rats in group -> 
### n() which gives the current group size ??
rats_long_s <- rats_long %>%
  group_by(Group, Time) %>%
  summarise(mean = mean(Weight), se = sd(Weight) /  sqrt(n())) %>%
  ungroup()

# Plot the mean profiles
ggplot(rats_long_s , aes(x = Time, y = mean, linetype = Group, shape = Group, col = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.9,0.45)) +
  scale_y_continuous(name = "mean(weight) +/- se(weight)")

```

## 6.2 BPRS

*_Implement the analyses of Chapter 9 of MABS using the BPRS data. (0-8 points: 0-4 points for graphs or analysis results + 0-4 points for their interpretations)_*

In this subchapter I will implement the analyses of Chapter 9 of MABS using the BPRS data.

### 6.2.1 Data

```{r message=FALSE, warning=FALSE}
# load the data in long format
bprs_long <- read.table("data/bprs_long.csv", sep = ";")

```

### 6.2.2 Something